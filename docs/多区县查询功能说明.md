# 多区县查询功能说明

## 概述

多区县查询功能允许在一个配置项中同时查询多个区县的观测数据，特别适合以下场景：
- 定义逻辑上的观测区域（如"核心城区"、"郊区"等）
- 需要合并多个相邻区县的数据
- 避免为每个区县单独创建配置项

## 配置方式

在 `config/birdreport_locations.json` 中，设置以下字段：

```json
{
  "id": "guilin_hexin_chengqu",
  "name": "桂林核心城区",
  "province": "广西壮族自治区",
  "city": "桂林市",
  "district": "",
  "mode": 0,
  "outside_type": 0,
  "default_days": 7,
  "query_level": "district",
  "districts": [
    "象山区",
    "七星区",
    "阳朔县"
  ],
  "point_aliases": []
}
```

### 关键字段说明

| 字段 | 必需 | 说明 |
|------|------|------|
| `query_level` | ✓ | 必须设置为 `"district"` |
| `districts` | ✓ | 字符串数组，包含要查询的区县名称 |
| `district` | ✗ | 留空即可 |
| `point_aliases` | ✗ | 留空数组 `[]` |

## 查询过程

当系统检测到 `query_level` 为 `"district"` 且存在 `districts` 数组时，会：

1. **遍历区县列表**：依次对每个区县发起独立查询
2. **显示进度**：为每个区县显示查询进度和结果
3. **合并去重**：自动合并所有区县的结果，按鸟种去重

### 查询输出示例

```
🔐 桂林核心城区 - 多区县查询: 3 个区县
  🔍 象山区: 调用 API ...
  ✅ 象山区: 返回 17 条记录
  🔍 七星区: 调用 API ...
  ✅ 七星区: 返回 11 条记录
  🔍 阳朔县: 调用 API ...
  ✅ 阳朔县: 返回 3 条记录
📊 桂林核心城区 去重鸟种: 28
```

## 使用方法

### 方法 1: 使用 fetch_from_birdreport.py

```bash
python3 tools/fetch_from_birdreport.py \
  --location-config config/birdreport_locations.json \
  --location guilin_hexin_chengqu \
  --days 7
```

输出示例：
```
🌍 处理地点: 桂林核心城区 (guilin_hexin_chengqu)
📍 查询级别: 区县级别 (多区县: 3 个)
🔐 自定义查询1: 调用 API 抓取...
✅ 自定义查询1: 返回 17 条记录
🔐 自定义查询2: 调用 API 抓取...
✅ 自定义查询2: 返回 11 条记录
🔐 自定义查询3: 调用 API 抓取...
✅ 自定义查询3: 返回 3 条记录
✅ 找到 31 条记录
📊 去重后: 28 种鸟类
```

### 方法 2: 使用 run_weekly_refresh.py

```bash
python3 tools/run_weekly_refresh.py \
  --days 7 \
  --locations guilin_hexin_chengqu \
  --min-species 10
```

输出示例：
```
🌍 处理地点: 核心城区 (guilin_hexin_chengqu)
🔐 核心城区 - 多区县查询: 3 个区县
  🔍 象山区: 调用 API ...
  ✅ 象山区: 返回 17 条记录
  🔍 七星区: 调用 API ...
  ✅ 七星区: 返回 11 条记录
  🔍 阳朔县: 调用 API ...
  ✅ 阳朔县: 返回 3 条记录
📊 核心城区 去重鸟种: 28
```

## 与其他查询模式的对比

### 1. 地点级别 (point) - 使用 point_aliases

```json
{
  "query_level": "point",
  "point_aliases": ["象山区", "七星区", "阳朔县"]
}
```

**问题：**
- 只查询地点**名称**包含这些关键词的观测点
- 会遗漏地点名称中不包含区县名的观测点
- 数据不完整

### 2. 多区县级别 (district + districts)

```json
{
  "query_level": "district",
  "districts": ["象山区", "七星区", "阳朔县"]
}
```

**优势：**
- 查询整个区县**行政范围**内的所有观测点
- 数据完整，不遗漏
- 自动合并去重

### 3. 城市级别 (city)

```json
{
  "query_level": "city",
  "city": "桂林市"
}
```

**区别：**
- 查询整个城市的**所有区县**
- 如果只需要特定几个区县，会返回过多数据

## 适用场景

### 适合使用多区县查询的场景：

✓ **核心城区**：象山区 + 七星区 + 秀峰区
✓ **郊区范围**：临桂区 + 雁山区
✓ **生态区域**：多个自然保护区所在的区县
✓ **观鸟路线**：跨越多个区县的观鸟路线

### 不适合的场景：

✗ 需要查询整个城市 → 使用 `query_level: "city"`
✗ 只查询单个区县 → 使用单区县模式或 `district` 字段
✗ 查询具体观鸟点 → 使用 `query_level: "point"` + `point_aliases`

## 性能考虑

- **查询次数**：每个区县发起一次 API 请求
- **查询时间**：总时间 = 单次查询时间 × 区县数量
- **数据量**：取决于各区县的观测记录数量
- **建议**：
  - 控制 `districts` 数组长度（建议不超过 10 个）
  - 使用 `default_days` 或 `--days` 控制时间范围
  - 对于数据量大的城市，考虑拆分为多个配置项

## 错误处理

如果某个区县查询失败：
- 系统会显示警告信息
- 继续查询其他区县
- 只要有一个区县成功，整体查询就成功
- 如果所有区县都失败，则抛出错误

示例：
```
  🔍 象山区: 调用 API ...
  ✅ 象山区: 返回 17 条记录
  🔍 七星区: 调用 API ...
  ⚠️  七星区 查询失败: Network timeout
  🔍 阳朔县: 调用 API ...
  ✅ 阳朔县: 返回 3 条记录
📊 桂林核心城区 去重鸟种: 20
```

## 总结

多区县查询功能让你可以：
- ✅ 灵活组合多个区县作为一个逻辑地点
- ✅ 获取完整的区县级别数据（而不是地点名称匹配）
- ✅ 自动合并去重结果
- ✅ 清晰的查询进度展示

这个功能特别适合需要管理复杂地理区域的观鸟数据采集场景。
