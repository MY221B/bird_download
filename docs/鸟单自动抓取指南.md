# 鸟单自动抓取指南

本指南基于 `tools/fetch_from_birdreport.py` 的新版能力，帮助你按地点 / 时间批量抓取中国观鸟记录中心的鸟类名单，并自动合并多搜索词的结果。

## 1. 环境准备

1. 安装依赖（只需一次）：
   ```bash
   python3 -m pip install --user requests pycryptodome
   ```
2. 确保可以访问 `https://api.birdreport.cn`。
3. 可选：编辑 `config/birdreport_locations.json`，为常用地点维护统一配置。

## 2. 三种使用方式

### 2.1 传统 URL 模式
保持原有行为，传入完整链接即可：
```bash
python3 tools/fetch_from_birdreport.py 'https://www.birdreport.cn/home/search/taxon.html?search=...'
```
脚本会先尝试 API 抓取，失败时自动回退到 HTML 解析。

### 2.2 参数模式（无需复制链接）
手动指定地点、时间等参数，脚本自动构造 API 请求：
```bash
python3 tools/fetch_from_birdreport.py \
  --province 北京市 \
  --pointname 奥森南园 \
  --start 2025-11-07 --end 2025-11-14
```
常用参数：
- `--start/--end`: 日期范围（YYYY-MM-DD）。
- `--days`: 按天数回溯，如 `--days 7` 表示“截至今天的最近 7 天”，可替代 `--start/--end`。
- `--province/--city/--district`: 地理筛选。
- `--pointname`: 单一地点名。
- `--aliases`: 多个搜索词，示例 `--aliases 奥森北园 奥林匹克森林公园北园`，脚本会顺序抓取并自动去重。
- 其他原始参数（`--taxonid`, `--mode`, `--outside-type` 等）也可按需覆盖。

支持将结果写入文件：
```bash
python3 tools/fetch_from_birdreport.py --pointname 奥森南园 --days 7 --output data/aosen_south.txt
```

> **提示**：当 `start/end` 跨月时，脚本会自动按月份拆分成多次 API 请求并合并去重，避免遗漏后一个月的数据，也无需手动切分日期。

### 2.3 配置驱动模式
将常用地点及其别名写入 `config/birdreport_locations.json`：
```json
{
  "locations": [
    {
      "id": "aosen_north",
      "name": "奥森北园",
      "province": "北京市",
      "mode": 0,
      "outside_type": 0,
      "default_days": 7,
      "point_aliases": [
        "奥森北园",
        "奥林匹克森林公园北园"
      ]
    }
  ]
}
```
然后通过 id 或 name 调用：
```bash
python3 tools/fetch_from_birdreport.py \
  --location-config config/birdreport_locations.json \
  --location aosen_north \
  --days 7 \
  --output data/aosen_north_$(date +%Y%m%d).txt
```
- `point_aliases` 数组可列出所有需要并集的搜索词，脚本逐一抓取并自动去重。
- `default_days`：未手动指定日期时的回溯天数。
- 任何 CLI 参数都可以覆盖配置（例如临时改 `--start/--end`）。

### 2.4 周刷新脚本（自动完成下载+上传+复制）
当需要一键跑完整个流程（抓鸟单 → 下载图片 → 上传 Cloudinary → 拷贝 JSON 到 `feather-flash-quiz`）时，可使用：
```bash
python3 tools/run_weekly_refresh.py \
  --days 7 \
  --min-species 10 \
  --locations aosen_north aosen_south yuanmingyuan
```
- 默认遍历 `config/birdreport_locations.json`，对每个地点调用 `fetch_from_birdreport.py`、`convert_to_csv.py` 以及 `process_new_birds.py` 中的核心函数。
- 最新一周的 Cloudinary JSON 会复制到 `feather-flash-quiz/location_birds/<地点>/<YYMMDD>`。若去重鸟种数低于 `--min-species`（默认 10），会跳过该地点以保留上次报告。
- 终端会打印每一步状态、下载了哪些新鸟及需要人工复核/推送 Lovable 的提醒，便于每周例行任务使用。

## 3. 批量/定时方案
1. **维护清单**：把所有地点写在 `config/birdreport_locations.json`，必要时新增/删除条目或别名即可。
2. **批量脚本**：写一个 shell / Python driver，遍历地点列表并调用：
   ```bash
   while read -r LOC; do
     python3 tools/fetch_from_birdreport.py \
       --location-config config/birdreport_locations.json \
       --location "$LOC" --days 7 \
       --output "data/${LOC}_$(date +%Y%m%d).txt"
   done < locations.txt
   ```
3. **定时任务**：使用 cron/Systemd 等按周/月运行 driver，并记录日志。
4. **管线衔接**：抓取完成后，可直接把输出喂给 `convert_to_csv.py` 或 `process_new_birds.py`：
   ```bash
   python3 tools/fetch_from_birdreport.py --location ... --output tmp/new_birds.txt
   python3 tools/convert_to_csv.py --auto tmp/new_birds.txt > tmp/new_birds.csv
   python3 tools/process_new_birds.py
   ```

## 4. 常见问题
- **抓取失败 / 无结果**：检查依赖是否安装、参数是否正确，以及该地点在时间范围内是否有记录。
- **签名被拒 (400)**：确保系统时间准确，避免代理篡改；也可稍候重试。
- **HTTPS 证书警告**：脚本已禁用校验，无需额外操作。
- **新增地点**：在配置文件新增条目并写好 `point_aliases`，无需改代码。

通过以上方式，即可批量、自动地刷新不同地点/日期的鸟类名单，并与现有流水线无缝衔接。
